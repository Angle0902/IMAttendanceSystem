<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Attendance App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .attendance-radio, .mode-radio { display: none; }
        .attendance-label, .mode-label { display: inline-block; cursor: pointer; padding: 0.5rem 1rem; border-radius: 9999px; transition: all 0.2s ease-in-out; font-weight: 500; min-width: 80px; text-align: center; }
        .attendance-radio:checked + .attendance-label-present { background-color: #10b981; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .attendance-radio:not(:checked) + .attendance-label-present { background-color: #d1fae5; color: #065f46; }
        .attendance-radio:checked + .attendance-label-absent { background-color: #ef4444; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .attendance-radio:not(:checked) + .attendance-label-absent { background-color: #fee2e2; color: #991b1b; }
        .attendance-radio:checked + .attendance-label-late { background-color: #f97316; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .attendance-radio:not(:checked) + .attendance-label-late { background-color: #ffedd5; color: #9a3412; }
        .mode-radio:checked + .mode-label { background-color: #4f46e5; color: white; }
        .mode-radio:not(:checked) + .mode-label { background-color: #e0e7ff; color: #3730a3; }
        #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 100; }
        .toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; color: white; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .toast.show { opacity: 1; transform: translateX(0); }
        #export-modal, #import-modal { z-index: 60; }
        .modal-content, #login-card { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Login Screen -->
    <div id="login-screen" class="hidden fixed inset-0 bg-gray-100 flex items-center justify-center p-4 z-50">
        <div id="login-card" class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-900">Welcome!</h2>
            <p class="text-center text-gray-600 mt-2 mb-6">Sign in to manage your attendance records.</p>
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="Email Address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                <input type="password" id="password-input" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
            </div>
            <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button id="login-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition"><i class="fas fa-sign-in-alt mr-2"></i>Login</button>
                <button id="signup-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-3 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition"><i class="fas fa-user-plus mr-2"></i>Sign Up</button>
            </div>
        </div>
    </div>


    <!-- App Container -->
    <div id="app-container" class="hidden min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900">Attendance Dashboard</h1>
                    <p class="text-lg text-gray-600 mt-1">Manage your classes and track student attendance seamlessly.</p>
                    <div id="user-info" class="mt-2 text-sm text-gray-500"></div>
                </div>
                 <div class="flex gap-4">
                    <button id="show-export-modal-btn" class="bg-teal-600 text-white font-bold px-5 py-3 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-file-csv mr-2"></i>Export Report
                    </button>
                    <button id="logout-btn" class="bg-red-600 text-white font-bold px-5 py-3 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition transform hover:scale-105">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </header>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
                 <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
            </div>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="lg:col-span-1 space-y-8">
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4 flex items-center"><i class="fas fa-chalkboard-teacher mr-3 text-indigo-500"></i>Select Grade Level</h2>
                        <div id="class-list" class="mt-4 space-y-2 max-h-[80vh] overflow-y-auto"></div>
                    </div>
                    <div id="management-hub" class="bg-white p-6 rounded-2xl shadow-md hidden">
                        <h2 class="text-2xl font-semibold mb-4 flex items-center"><i class="fas fa-cogs mr-3 text-gray-600"></i>Grade Level Hub</h2>
                        <h3 id="hub-header" class="text-lg font-medium text-gray-700 mb-4"></h3>
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-lg font-medium text-gray-700 flex items-center"><i class="fas fa-users mr-2 text-green-500"></i>Manage Students</h4>
                                <button id="show-import-modal-btn" class="text-sm bg-green-100 text-green-800 font-semibold px-3 py-1 rounded-full hover:bg-green-200"><i class="fas fa-upload mr-1"></i> Import</button>
                            </div>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-3"><input type="text" id="new-student-firstname" placeholder="First Name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"><input type="text" id="new-student-lastname" placeholder="Last Name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"></div>
                                <input type="text" id="new-student-middlename" placeholder="Middle Name (Optional)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                 <select id="new-student-section" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 bg-white disabled:bg-gray-100" disabled><option value="">Select Section</option></select>
                                <button id="add-student-btn" class="w-full bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"><i class="fas fa-user-plus mr-2"></i>Add Student</button>
                            </div>
                            <div id="student-list" class="mt-4 max-h-48 overflow-y-auto pr-2"></div>
                        </div>
                         <div class="mt-6 border-t pt-4">
                            <h4 class="text-lg font-medium text-gray-700 mb-3 flex items-center"><i class="fas fa-archive mr-2 text-orange-500"></i>Manage Sections</h4>
                             <div class="flex space-x-2"><input type="text" id="new-section-name" placeholder="New Section Name" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"><button id="add-section-btn" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500"><i class="fas fa-plus"></i></button></div>
                             <div id="section-list" class="mt-4 space-y-2 max-h-32 overflow-y-auto pr-2"></div>
                        </div>
                        <div class="mt-6 border-t pt-4">
                            <h4 class="text-lg font-medium text-gray-700 mb-3 flex items-center"><i class="fas fa-book mr-2 text-purple-500"></i>Manage Subjects</h4>
                             <div class="flex space-x-2"><input type="text" id="new-subject-name" placeholder="New Subject" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"><button id="add-subject-btn" class="bg-purple-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"><i class="fas fa-plus"></i></button></div>
                             <div id="subject-list" class="mt-4 space-y-2 max-h-32 overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="lg:col-span-2 space-y-8">
                     <!-- Attendance Summary -->
                    <div class="bg-white p-6 rounded-2xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4 flex items-center"><i class="fas fa-chart-pie mr-3 text-cyan-500"></i>Attendance Summary</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
                             <select id="summary-grade-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 bg-white"><option value="">Select Grade</option></select>
                             <select id="summary-section-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 bg-white" disabled><option value="all">All Sections</option></select>
                             <select id="summary-year-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 bg-white"></select>
                             <select id="summary-month-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 bg-white"></select>
                        </div>
                        <div id="summary-results-container">
                             <div class="text-center py-8 text-gray-500">Select filters to view summary.</div>
                        </div>
                    </div>

                    <div id="attendance-section" class="bg-white p-6 rounded-2xl shadow-md hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                           <div class="flex items-center gap-4">
                                <div><h2 class="text-2xl font-semibold flex items-center"><i class="fas fa-calendar-check mr-3 text-blue-500"></i>Take Attendance</h2><p id="attendance-header" class="text-lg text-gray-600"></p></div>
                                <button id="sort-students-btn" class="text-sm bg-gray-200 text-gray-800 font-semibold px-3 py-2 rounded-full hover:bg-gray-300 transition-colors"><i class="fas fa-sort-alpha-down mr-1"></i> Sort A-Z</button>
                            </div>
                             <input type="date" id="attendance-date" class="mt-4 sm:mt-0 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-4 p-1 bg-indigo-100 rounded-full flex justify-center space-x-2"><input type="radio" name="attendance-mode" id="mode-daily" value="daily" class="mode-radio" checked><label for="mode-daily" class="mode-label w-1/2">Entire Day</label><input type="radio" name="attendance-mode" id="mode-subject" value="subject" class="mode-radio"><label for="mode-subject" class="mode-label w-1/2">Per Subject</label></div>
                        <select id="attendance-subject" class="w-full mb-4 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white hidden"></select>
                        <div id="attendance-list" class="space-y-4"></div>
                        <div id="no-students-message" class="hidden text-center py-12"><i class="fas fa-user-graduate text-4xl text-gray-400 mb-4"></i><h3 class="text-xl font-medium text-gray-700">No students yet!</h3><p class="text-gray-500">Add or import students to this class.</p></div>
                        <div id="no-subjects-message" class="hidden text-center py-12"><i class="fas fa-book-open text-4xl text-gray-400 mb-4"></i><h3 class="text-xl font-medium text-gray-700">No subjects yet!</h3><p class="text-gray-500">Add a subject to take per-subject attendance.</p></div>
                        <div class="mt-6 text-right"><button id="save-attendance-btn" class="bg-blue-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition transform hover:scale-105 disabled:bg-gray-400"><i class="fas fa-save mr-2"></i>Save Attendance</button></div>
                    </div>
                     <div id="attendance-placeholder" class="bg-white p-12 text-center rounded-2xl shadow-md flex flex-col items-center justify-center h-full"><i class="fas fa-chalkboard text-5xl text-gray-400 mb-4"></i><h3 class="text-2xl font-medium text-gray-700">Select a Grade Level</h3><p class="text-gray-500 mt-2 max-w-sm">Please select a grade to begin.</p></div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="export-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"><div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-2xl bg-white modal-content"><div class="mt-3 text-center"><h3 class="text-2xl leading-6 font-bold text-gray-900 mb-4">Export Attendance Report</h3><div class="space-y-4 px-7 py-3 text-left"><div><label for="export-class-select" class="block text-sm font-medium text-gray-700 mb-1">Select Grade Level</label><select id="export-class-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 bg-white"></select></div><div class="grid grid-cols-2 gap-4"><div><label for="export-date-start" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label><input type="date" id="export-date-start" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></div><div><label for="export-date-end" class="block text-sm font-medium text-gray-700 mb-1">End Date</label><input type="date" id="export-date-end" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"></div></div></div><div class="items-center px-4 py-3 space-y-2"><button id="export-csv-btn" class="w-full bg-teal-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition"><i class="fas fa-download mr-2"></i>Export to CSV</button><button id="close-export-modal-btn" class="w-full bg-gray-200 text-gray-800 font-bold px-6 py-3 rounded-lg hover:bg-gray-300 focus:outline-none">Cancel</button></div></div></div></div>
    <div id="import-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"><div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-2xl bg-white modal-content"><div class="mt-3"><h3 class="text-2xl leading-6 font-bold text-gray-900 text-center mb-4">Import Students via CSV</h3><div class="px-4 py-3 text-sm text-gray-600 bg-gray-50 rounded-lg"><p class="font-semibold">Instructions:</p><ol class="list-decimal list-inside mt-2 space-y-1"><li>Prepare a CSV file with the headers: `FirstName`, `LastName`, `MiddleName`, `Section`.</li><li>`MiddleName` is optional. Leave the cell blank if not applicable.</li><li>The `Section` must exactly match a section you've set up for the currently selected grade level.</li><li><a href="#" id="download-template-btn" class="text-indigo-600 hover:underline font-semibold">Download Template CSV</a></li></ol></div><div class="mt-4"><label for="csv-file-input" class="block text-sm font-medium text-gray-700 mb-1">Select CSV File</label><input type="file" id="csv-file-input" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/></div><div class="items-center px-4 py-3 mt-4 space-y-2 border-t"><button id="import-csv-btn" class="w-full bg-green-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition disabled:bg-gray-400"><i class="fas fa-check-circle mr-2"></i>Import Students</button><button id="close-import-modal-btn" class="w-full bg-gray-200 text-gray-800 font-bold px-6 py-3 rounded-lg hover:bg-gray-300 focus:outline-none">Cancel</button></div></div></div></div>
    
    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, writeBatch, serverTimestamp, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
        apiKey: "AIzaSyCQHVXqgrcEOPxGRbiTq-_EBOGIgX-n-K0",
        authDomain: "jhs-attendance-app.firebaseapp.com",
        projectId: "jhs-attendance-app",
        storageBucket: "jhs-attendance-app.firebasestorage.app",
        messagingSenderId: "622813604760",
        appId: "1:622813604760:web:6bd481932e154512b5d9ed",
        measurementId: "G-BQVD6JB7D5"
        };

        const appId = 'my-attendance-app';
        let app, db, auth, userId = null, currentClass = null;
        let unsubscribe = { students: ()=>{}, subjects: ()=>{}, sections: ()=>{}, attendance: ()=>{} };
        const GRADES = ['Kindergarten', ...Array.from({length: 12}, (_, i) => `Grade ${i + 1}`)];
        let sortOrder = 'asc';
        let currentStudentList = [];
        
        const elements = {
            loginScreen: document.getElementById('login-screen'),
            appContainer: document.getElementById('app-container'),
            emailInput: document.getElementById('email-input'),
            passwordInput: document.getElementById('password-input'),
            loginBtn: document.getElementById('login-btn'),
            signupBtn: document.getElementById('signup-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            loadingSpinner: document.getElementById('loading-spinner'),
            userInfo: document.getElementById('user-info'),
            classList: document.getElementById('class-list'),
            managementHub: document.getElementById('management-hub'),
            hubHeader: document.getElementById('hub-header'),
            studentList: document.getElementById('student-list'),
            newStudentFirstNameInput: document.getElementById('new-student-firstname'),
            newStudentMiddleNameInput: document.getElementById('new-student-middlename'),
            newStudentLastNameInput: document.getElementById('new-student-lastname'),
            newStudentSectionSelect: document.getElementById('new-student-section'),
            addStudentBtn: document.getElementById('add-student-btn'),
            sectionList: document.getElementById('section-list'),
            newSectionNameInput: document.getElementById('new-section-name'),
            addSectionBtn: document.getElementById('add-section-btn'),
            subjectList: document.getElementById('subject-list'),
            newSubjectNameInput: document.getElementById('new-subject-name'),
            addSubjectBtn: document.getElementById('add-subject-btn'),
            attendanceSection: document.getElementById('attendance-section'),
            attendancePlaceholder: document.getElementById('attendance-placeholder'),
            attendanceHeader: document.getElementById('attendance-header'),
            sortStudentsBtn: document.getElementById('sort-students-btn'),
            attendanceDateInput: document.getElementById('attendance-date'),
            attendanceModeDaily: document.getElementById('mode-daily'),
            attendanceModeSubject: document.getElementById('mode-subject'),
            attendanceSubjectSelect: document.getElementById('attendance-subject'),
            attendanceList: document.getElementById('attendance-list'),
            saveAttendanceBtn: document.getElementById('save-attendance-btn'),
            noStudentsMessage: document.getElementById('no-students-message'),
            noSubjectsMessage: document.getElementById('no-subjects-message'),
            toastContainer: document.getElementById('toast-container'),
            exportModal: document.getElementById('export-modal'),
            showExportModalBtn: document.getElementById('show-export-modal-btn'),
            closeExportModalBtn: document.getElementById('close-export-modal-btn'),
            exportClassSelect: document.getElementById('export-class-select'),
            exportDateStart: document.getElementById('export-date-start'),
            exportDateEnd: document.getElementById('export-date-end'),
            exportCsvBtn: document.getElementById('export-csv-btn'),
            importModal: document.getElementById('import-modal'),
            showImportModalBtn: document.getElementById('show-import-modal-btn'),
            closeImportModalBtn: document.getElementById('close-import-modal-btn'),
            downloadTemplateBtn: document.getElementById('download-template-btn'),
            csvFileInput: document.getElementById('csv-file-input'),
            importCsvBtn: document.getElementById('import-csv-btn'),
            summaryGradeSelect: document.getElementById('summary-grade-select'),
            summarySectionSelect: document.getElementById('summary-section-select'),
            summaryYearSelect: document.getElementById('summary-year-select'),
            summaryMonthSelect: document.getElementById('summary-month-select'),
            summaryResultsContainer: document.getElementById('summary-results-container'),
        };

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupEventListeners();
                await setPersistence(auth, browserLocalPersistence);
                handleAuthentication();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                elements.loginScreen.classList.remove('hidden');
                showToast("Error initializing application.", 'error');
            }
        });

        function handleAuthentication() {
            onAuthStateChanged(auth, (user) => {
                showLoading(false);
                if (user) {
                    userId = user.uid;
                    elements.userInfo.textContent = `Signed in as: ${user.email || 'Anonymous User'}`;
                    elements.loginScreen.style.display = 'none';
                    elements.appContainer.style.display = 'block';
                    renderClassList();
                    initializeSummaryView();
                } else {
                    userId = null;
                    elements.loginScreen.style.display = 'flex';
                    elements.appContainer.style.display = 'none';
                    if(currentClass) resetToInitialState();
                }
            });
        }
        function showLoading(isLoading) { elements.loadingSpinner.style.display = isLoading ? 'flex' : 'none'; }
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : type === 'info' ? 'bg-blue-500' : 'bg-green-500';
            const icon = type === 'error' ? '<i class="fas fa-exclamation-circle mr-3"></i>' : type === 'info' ? '<i class="fas fa-info-circle mr-3"></i>' : '<i class="fas fa-check-circle mr-3"></i>';
            toast.className = `toast ${bgColor}`;
            toast.innerHTML = `${icon}<span>${message}</span>`;
            elements.toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        }
        function formatDate(date) { return date.toISOString().split('T')[0]; }
        function formatStudentName(s) { return `${s.lastName}, ${s.firstName} ${s.middleName || ''}`.trim(); }

        function setupEventListeners() {
            elements.loginBtn.addEventListener('click', handleEmailLogin);
            elements.signupBtn.addEventListener('click', handleEmailSignUp);
            elements.logoutBtn.addEventListener('click', () => signOut(auth));
            elements.addStudentBtn.addEventListener('click', addStudent);
            elements.addSectionBtn.addEventListener('click', addSection);
            elements.addSubjectBtn.addEventListener('click', addSubject);
            elements.saveAttendanceBtn.addEventListener('click', saveAttendance);
            elements.sortStudentsBtn.addEventListener('click', () => {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                elements.sortStudentsBtn.innerHTML = sortOrder === 'asc' 
                    ? '<i class="fas fa-sort-alpha-down mr-1"></i> Sort A-Z'
                    : '<i class="fas fa-sort-alpha-up mr-1"></i> Sort Z-A';
                renderAttendanceListUI(currentStudentList);
            });
            elements.attendanceDateInput.addEventListener('change', loadAttendance);
            elements.attendanceSubjectSelect.addEventListener('change', loadAttendance);
            elements.attendanceModeDaily.addEventListener('change', toggleAttendanceMode);
            elements.attendanceModeSubject.addEventListener('change', toggleAttendanceMode);
            elements.showExportModalBtn.addEventListener('click', openExportModal);
            elements.closeExportModalBtn.addEventListener('click', () => elements.exportModal.style.display = 'none');
            elements.exportCsvBtn.addEventListener('click', exportAttendanceToCSV);
            elements.showImportModalBtn.addEventListener('click', () => elements.importModal.style.display = 'block');
            elements.closeImportModalBtn.addEventListener('click', () => elements.importModal.style.display = 'none');
            elements.downloadTemplateBtn.addEventListener('click', downloadTemplate);
            elements.importCsvBtn.addEventListener('click', handleCSVImport);
            // Summary Listeners
            elements.summaryGradeSelect.addEventListener('change', handleSummaryGradeChange);
            elements.summarySectionSelect.addEventListener('change', fetchAndDisplaySummary);
            elements.summaryYearSelect.addEventListener('change', fetchAndDisplaySummary);
            elements.summaryMonthSelect.addEventListener('change', fetchAndDisplaySummary);
        }

        async function handleEmailLogin() {
            const email = elements.emailInput.value;
            const password = elements.passwordInput.value;
            if (!email || !password) return showToast('Please enter email and password.', 'error');
            showLoading(true);
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        async function handleEmailSignUp() {
            const email = elements.emailInput.value;
            const password = elements.passwordInput.value;
            if (!email || !password) return showToast('Please enter email and password.', 'error');
            showLoading(true);
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
       
        function renderClassList() {
            elements.classList.innerHTML = '';
            GRADES.forEach(grade => {
                const classEl = document.createElement('div');
                classEl.className = `p-3 rounded-lg cursor-pointer transition flex justify-between items-center group hover:bg-gray-100`;
                classEl.innerHTML = `<span>${grade}</span>`;
                classEl.dataset.gradeName = grade;
                classEl.addEventListener('click', () => handleClassSelection(grade));
                elements.classList.appendChild(classEl);
            });
        }
        
        function handleClassSelection(gradeName) {
            currentClass = { id: gradeName, name: gradeName };
            document.querySelectorAll('#class-list > div').forEach(el => {
                el.classList.toggle('bg-indigo-100', el.dataset.gradeName === gradeName);
                el.classList.toggle('text-indigo-800', el.dataset.gradeName === gradeName);
                el.classList.toggle('font-semibold', el.dataset.gradeName === gradeName);
            });
            elements.attendancePlaceholder.style.display = 'none';
            elements.attendanceSection.style.display = 'block';
            elements.managementHub.style.display = 'block';
            elements.hubHeader.textContent = `For ${gradeName}`;
            // Also update summary view
            elements.summaryGradeSelect.value = gradeName;
            handleSummaryGradeChange();
            loadStudents();
            loadSections();
            loadSubjects();
        }
        function resetToInitialState() {
            currentClass = null;
            elements.attendanceSection.style.display = 'none';
            elements.managementHub.style.display = 'none';
            elements.attendancePlaceholder.style.display = 'flex';
        }

        function addStudent() {
            const firstName = elements.newStudentFirstNameInput.value.trim();
            const lastName = elements.newStudentLastNameInput.value.trim();
            const middleName = elements.newStudentMiddleNameInput.value.trim();
            const section = elements.newStudentSectionSelect.value;
            if (!firstName || !lastName || !section) return showToast('Please provide first name, last name, and section.', 'error');
            if (!currentClass) return showToast('Please select a grade level first.', 'error');
            const studentData = { firstName, lastName, middleName, gradeLevel: currentClass.id, section, createdAt: serverTimestamp() };
            addDoc(collection(db, `artifacts/${appId}/users/${userId}/grades/${currentClass.id}/students`), studentData).then(() => {
                [elements.newStudentFirstNameInput, elements.newStudentLastNameInput, elements.newStudentMiddleNameInput, elements.newStudentSectionSelect].forEach(el => el.value = '');
                showToast('Student added successfully!');
            });
        }
        async function loadStudents() {
            if (!currentClass) return;
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/grades/${currentClass.id}/students`));
            unsubscribe.students();
            unsubscribe.students = onSnapshot(q, (snapshot) => {
                currentStudentList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderStudentList(currentStudentList);
                renderAttendanceListUI(currentStudentList); 
            });
        }
        function renderStudentList(students) {
            elements.studentList.innerHTML = '';
            if (!students || students.length === 0) { elements.studentList.innerHTML = '<p class="text-gray-500 text-center p-4">No students yet.</p>'; return; }
            students.sort((a,b) => formatStudentName(a).localeCompare(formatStudentName(b))).forEach(student => {
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md group';
                el.innerHTML = `<div>${formatStudentName(student)} <span class="text-sm text-gray-500">(${student.section})</span></div><button data-id="${student.id}" data-name="${formatStudentName(student)}" class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fas fa-times-circle"></i></button>`;
                el.querySelector('button').addEventListener('click', (e) => deleteItemFromSubcollection(e.currentTarget.dataset.id, e.currentTarget.dataset.name, 'students'));
                elements.studentList.appendChild(el);
            });
        }
        
        function addSection() {
            const name = elements.newSectionNameInput.value.trim();
            if (!name) return showToast('Please enter a section name.', 'error');
            if (!currentClass) return showToast('Please select a grade level first.', 'error');
            addDoc(collection(db, `artifacts/${appId}/users/${userId}/grades/${currentClass.id}/sections`), { name, createdAt: serverTimestamp() }).then(() => {
                elements.newSectionNameInput.value = '';
                showToast('Section added!');
            });
        }
        async function loadSections() {
             if (!currentClass) return;
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/grades/${currentClass.id}/sections`));
            unsubscribe.sections();
            unsubscribe.sections = onSnapshot(q, (snapshot) => {
                elements.sectionList.innerHTML = '';
                elements.newStudentSectionSelect.innerHTML = '<option value="">Select Section</option>';
                elements.newStudentSectionSelect.disabled = snapshot.empty;
                if(snapshot.empty) { elements.sectionList.innerHTML = '<p class="text-gray-500 text-center p-2">No sections yet.</p>'; return; }
                
                snapshot.docs.forEach(d => {
                    const section = d.data();
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md group';
                    el.innerHTML = `<span>${section.name}</span><button class="text-gray-400 hover:text-red-500" data-id="${d.id}" data-name="${section.name}"><i class="fas fa-times-circle"></i></button>`;
                    el.querySelector('button').addEventListener('click', (e) => deleteItemFromSubcollection(e.currentTarget.dataset.id, e.currentTarget.dataset.name, 'sections'));
                    elements.sectionList.appendChild(el);
                    elements.newStudentSectionSelect.appendChild(new Option(section.name, section.name));
                });
            });
        }

        function addSubject() {
            const name = elements.newSubjectNameInput.value.trim();
            if(!name) return showToast('Subject name cannot be empty.', 'error');
            if(!currentClass) return showToast('Please select a grade level first.', 'error');
            addDoc(collection(db, `artifacts/${appId}/users/${userId}/grades/${currentClass.id}/subjects`), { name, createdAt: serverTimestamp() }).then(() => {
                elements.newSubjectNameInput.value = '';
                showToast('Subject added!');
            });
        }
        async function loadSubjects() {
            if (!currentClass) return;
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/grades/${currentClass.id}/subjects`));
            unsubscribe.subjects();
            unsubscribe.subjects = onSnapshot(q, (snapshot) => {
                elements.subjectList.innerHTML = '';
                elements.attendanceSubjectSelect.innerHTML = '<option value="">Select Subject</option>';
                if (snapshot.empty) { elements.subjectList.innerHTML = '<p class="text-gray-500 text-center p-2">No subjects yet.</p>'; toggleAttendanceMode(); return; }
                snapshot.docs.forEach(d => {
                    const subject = d.data();
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md group';
                    el.innerHTML = `<span>${subject.name}</span><button class="text-gray-400 hover:text-red-500" data-id="${d.id}" data-name="${subject.name}"><i class="fas fa-times-circle"></i></button>`;
                    el.querySelector('button').addEventListener('click', (e) => deleteItemFromSubcollection(e.currentTarget.dataset.id, e.currentTarget.dataset.name, 'subjects'));
                    elements.subjectList.appendChild(el);
                    elements.attendanceSubjectSelect.appendChild(new Option(subject.name, d.id));
                });
                toggleAttendanceMode();
                loadAttendance();
            });
        }
        async function deleteItemFromSubcollection(itemId, itemName, collectionName) {
            if (confirm(`Are you sure you want to delete "${itemName}"?`)) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/grades/${currentClass.id}/${collectionName}`, itemId);
                await deleteDoc(docRef).catch(err => showToast(`Failed to delete.`, 'error'));
            }
        }
        
        function toggleAttendanceMode() {
            const isSubjectMode = elements.attendanceModeSubject.checked;
            const hasSubjects = elements.attendanceSubjectSelect.options.length > 1;
            elements.attendanceSubjectSelect.style.display = isSubjectMode ? 'block' : 'none';
            elements.noSubjectsMessage.style.display = isSubjectMode && !hasSubjects ? 'block' : 'none';
            elements.attendanceList.style.display = isSubjectMode && !hasSubjects ? 'none' : 'block';
            loadAttendance();
        }
        function renderAttendanceListUI(students) {
            elements.attendanceList.innerHTML = '';
            const hasStudents = students && students.length > 0;
            elements.noStudentsMessage.style.display = hasStudents ? 'none' : 'block';
            elements.saveAttendanceBtn.disabled = !hasStudents;
            if (!hasStudents) return;

            const sortedStudents = [...students].sort((a,b) => {
                const nameA = formatStudentName(a);
                const nameB = formatStudentName(b);
                return sortOrder === 'asc' ? nameA.localeCompare(nameB) : nameB.localeCompare(nameA);
            });

            sortedStudents.forEach(student => {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-1 md:grid-cols-3 gap-4 items-center p-3 border-b border-gray-200';
                row.dataset.studentId = student.id;
                row.innerHTML = `<div class="font-medium text-gray-800">${formatStudentName(student)} <span class="text-sm text-gray-500">(${student.section})</span></div><div class="md:col-span-2 flex justify-start md:justify-end space-x-2"><input type="radio" name="attendance-${student.id}" id="present-${student.id}" value="P" class="attendance-radio" checked><label for="present-${student.id}" class="attendance-label attendance-label-present">Present</label><input type="radio" name="attendance-${student.id}" id="absent-${student.id}" value="A" class="attendance-radio"><label for="absent-${student.id}" class="attendance-label attendance-label-absent">Absent</label><input type="radio" name="attendance-${student.id}" id="late-${student.id}" value="L" class="attendance-radio"><label for="late-${student.id}" class="attendance-label attendance-label-late">Late</label></div>`;
                elements.attendanceList.appendChild(row);
            });
            loadAttendance();
        }
        function loadAttendance() {
            if (!currentClass || !userId) return;
            const dateStr = elements.attendanceDateInput.value || formatDate(new Date());
            elements.attendanceDateInput.value = dateStr;
            const isSubjectMode = elements.attendanceModeSubject.checked;
            const subjectId = elements.attendanceSubjectSelect.value;
            elements.attendanceHeader.textContent = `For ${currentClass.name}`;
            if (isSubjectMode && subjectId) elements.attendanceHeader.textContent += ` - ${elements.attendanceSubjectSelect.selectedOptions[0]?.textContent}`;
            if (isSubjectMode && !subjectId) { applyAttendanceData({}); return; }
            const attendanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/attendance`);
            const q = isSubjectMode
                ? query(attendanceCollectionRef, where("gradeLevel", "==", currentClass.id), where("date", "==", dateStr), where("subjectId", "==", subjectId))
                : query(attendanceCollectionRef, where("gradeLevel", "==", currentClass.id), where("date", "==", dateStr), where("type", "==", "daily"));
            unsubscribe.attendance();
            unsubscribe.attendance = onSnapshot(q, (snapshot) => applyAttendanceData(snapshot.empty ? {} : snapshot.docs[0].data().studentRecords));
        }
        function applyAttendanceData(records) {
             document.querySelectorAll('#attendance-list > div[data-student-id]').forEach(row => {
                const status = records[row.dataset.studentId] || 'P';
                const radio = row.querySelector(`input[value="${status}"]`);
                if (radio) radio.checked = true;
            });
        }
        async function saveAttendance() {
            if (!currentClass || !userId) return showToast('No grade level selected.', 'error');
            const dateStr = elements.attendanceDateInput.value;
            const isSubjectMode = elements.attendanceModeSubject.checked;
            const subjectId = elements.attendanceSubjectSelect.value;
            if (isSubjectMode && !subjectId) return showToast('Please select a subject.', 'error');
            const studentRecords = {};
            document.querySelectorAll('#attendance-list div[data-student-id]').forEach(row => { studentRecords[row.dataset.studentId] = row.querySelector('input:checked').value; });
            if (Object.keys(studentRecords).length === 0) return showToast('No students to save.', 'error');
            showLoading(true);
            const attendanceCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/attendance`);
            let q; let dataToSave = { gradeLevel: currentClass.id, date: dateStr, studentRecords, lastModified: serverTimestamp() };
            if (isSubjectMode) {
                q = query(attendanceCollectionRef, where("gradeLevel", "==", currentClass.id), where("date", "==", dateStr), where("subjectId", "==", subjectId));
                dataToSave = { ...dataToSave, type: 'subject', subjectId, subjectName: elements.attendanceSubjectSelect.selectedOptions[0]?.textContent };
            } else {
                q = query(attendanceCollectionRef, where("gradeLevel", "==", currentClass.id), where("date", "==", dateStr), where("type", "==", "daily"));
                dataToSave.type = 'daily';
            }
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) await updateDoc(querySnapshot.docs[0].ref, dataToSave);
            else await addDoc(attendanceCollectionRef, { ...dataToSave, createdAt: serverTimestamp() });
            showToast('Attendance saved!');
            showLoading(false);
        }

        function openExportModal() {
            elements.exportClassSelect.innerHTML = '<option value="">Select Grade</option>';
            GRADES.forEach(g => elements.exportClassSelect.appendChild(new Option(g,g)));
            elements.exportModal.style.display = 'block';
            elements.exportDateStart.value = formatDate(new Date());
            elements.exportDateEnd.value = formatDate(new Date());
        }
        
        async function exportAttendanceToCSV() {
            const gradeLevel = elements.exportClassSelect.value;
            const startDate = elements.exportDateStart.value;
            const endDate = elements.exportDateEnd.value;

            if(!gradeLevel || !startDate || !endDate) return showToast('Please fill all export fields.', 'error');
            if(startDate > endDate) return showToast('Start date cannot be after end date.', 'error');
            
            showLoading(true);
            
            try {
                const studentsRef = collection(db, `artifacts/${appId}/users/${userId}/grades/${gradeLevel}/students`);
                const attendanceRef = collection(db, `artifacts/${appId}/users/${userId}/attendance`);

                const [studentsSnapshot, attendanceSnapshot] = await Promise.all([
                    getDocs(query(studentsRef)),
                    getDocs(query(attendanceRef, where('gradeLevel', '==', gradeLevel)))
                ]);

                const studentsMap = new Map(studentsSnapshot.docs.map(d => [d.id, d.data()]));
                
                const attendanceData = attendanceSnapshot.docs
                    .map(d => d.data())
                    .filter(record => record.date >= startDate && record.date <= endDate);

                let csvRows = ['Date,LastName,FirstName,MiddleName,Grade,Section,Status,Type,Subject'];
                const statusMap = { 'P': 'Present', 'A': 'Absent', 'L': 'Late' };
                
                attendanceData.sort((a, b) => a.date.localeCompare(b.date)).forEach(record => {
                    for (const studentId in record.studentRecords) {
                        const student = studentsMap.get(studentId);
                        if (student) {
                            const status = record.studentRecords[studentId];
                            const row = [
                                record.date,
                                student.lastName,
                                student.firstName,
                                student.middleName || '',
                                student.gradeLevel,
                                student.section,
                                statusMap[status] || 'Unknown',
                                record.type === 'daily' ? 'Full Day' : 'Per Subject',
                                record.subjectName || 'N/A'
                            ].map(value => {
                                const str = String(value || '').replace(/"/g, '""');
                                return `"${str}"`;
                            }).join(',');
                            csvRows.push(row);
                        }
                    }
                });

                if (csvRows.length <= 1) {
                    showToast('No attendance records found for the selected range.', 'info');
                    showLoading(false);
                    return;
                }

                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `Attendance_${gradeLevel.replace(' ','_')}_${startDate}_to_${endDate}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                }, 100);
                
                elements.exportModal.style.display = 'none';
                showToast('Export successful!');

            } catch (error) {
                console.error("CSV Export Error:", error);
                showToast('An error occurred during export.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function downloadTemplate(e) {
            e.preventDefault();
            const content = "FirstName,LastName,MiddleName,Section\nJohn,Doe,,A\nJane,Smith,Anne,B";
            const link = document.createElement("a");
            link.setAttribute("href", 'data:text/csv;charset=utf-8,' + encodeURIComponent(content));
            link.setAttribute("download", `student_import_template.csv`);
            link.click();
        }
        async function handleCSVImport() {
            const file = elements.csvFileInput.files[0];
            if (!file) return showToast('Please select a file to import.', 'error');
            if (!currentClass) return showToast('Please select a grade level first.', 'error');
            showLoading(true);

            try {
                const sectionsQuery = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/grades/${currentClass.id}/sections`));
                const validSections = new Set(sectionsQuery.docs.map(d => d.data().name));

                const fileContent = await file.text();
                const rows = fileContent.split('\n').slice(1);
                const batch = writeBatch(db);
                let successfulImports = 0;
                let skippedRows = 0;

                rows.forEach(rowStr => {
                    if (rowStr.trim() === '') return;
                    const [firstName, lastName, middleName, section] = rowStr.split(',').map(s => s.trim());
                    if (firstName && lastName && section && validSections.has(section)) {
                        const newStudentRef = doc(collection(db, `artifacts/${appId}/users/${userId}/grades/${currentClass.id}/students`));
                        batch.set(newStudentRef, { firstName, lastName, middleName, gradeLevel: currentClass.id, section, createdAt: serverTimestamp() });
                        successfulImports++;
                    } else {
                        skippedRows++;
                    }
                });

                if (successfulImports > 0) await batch.commit();
                showToast(`Import complete: ${successfulImports} students added, ${skippedRows} rows skipped due to missing data or invalid section.`, 'info');
                elements.importModal.style.display = 'none';
                elements.csvFileInput.value = '';
            } catch (error) {
                console.error("CSV Import Error:", error);
                showToast('An error occurred during import.', 'error');
            } finally {
                showLoading(false);
            }
        }

        // --- SUMMARY VIEW ---
        function initializeSummaryView(){
            const yearSelect = elements.summaryYearSelect;
            const monthSelect = elements.summaryMonthSelect;
            yearSelect.innerHTML = '';
            monthSelect.innerHTML = '';
            
            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 5; i++) {
                const year = currentYear - i;
                yearSelect.appendChild(new Option(year, year));
            }

            monthSelect.appendChild(new Option('All Months', 'all'));
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            months.forEach((month, index) => {
                monthSelect.appendChild(new Option(month, index + 1));
            });
            monthSelect.value = 'all';

            elements.summaryGradeSelect.innerHTML = '<option value="">Select Grade</option>';
            GRADES.forEach(g => elements.summaryGradeSelect.appendChild(new Option(g,g)));
        }

        async function handleSummaryGradeChange(){
            const grade = elements.summaryGradeSelect.value;
            const sectionSelect = elements.summarySectionSelect;
            sectionSelect.innerHTML = '<option value="all">All Sections</option>';
            sectionSelect.disabled = true;

            if(!grade){
                fetchAndDisplaySummary();
                return;
            }

            const q = query(collection(db, `artifacts/${appId}/users/${userId}/grades/${grade}/sections`));
            const snapshot = await getDocs(q);
            if(!snapshot.empty){
                snapshot.docs.forEach(d => {
                    sectionSelect.appendChild(new Option(d.data().name, d.data().name));
                });
                sectionSelect.disabled = false;
            }
            fetchAndDisplaySummary();
        }

        async function fetchAndDisplaySummary(){
            const grade = elements.summaryGradeSelect.value;
            const section = elements.summarySectionSelect.value;
            const month = elements.summaryMonthSelect.value;
            const year = elements.summaryYearSelect.value;
            
            elements.summaryResultsContainer.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';
            if(!grade || !month || !year) {
                elements.summaryResultsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">Please select a grade, year, and month/all.</div>';
                return;
            }

            let startDate, lastDate;
            if(month === 'all') {
                startDate = `${year}-01-01`;
                lastDate = `${year}-12-31`;
            } else {
                startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                const endDate = new Date(year, month, 0).getDate();
                lastDate = `${year}-${String(month).padStart(2, '0')}-${endDate}`;
            }

            try {
                // 1. Get students
                let studentsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/grades/${grade}/students`));
                if(section !== 'all') {
                    studentsQuery = query(studentsQuery, where('section', '==', section));
                }
                const studentsSnapshot = await getDocs(studentsQuery);
                const studentMap = new Map(studentsSnapshot.docs.map(d => [d.id, d.data()]));
                const studentIds = Array.from(studentMap.keys());
                
                if (studentIds.length === 0) {
                     elements.summaryResultsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No students found for this selection.</div>';
                    return;
                }
                
                // 2. Get attendance for the month
                const attendanceRef = collection(db, `artifacts/${appId}/users/${userId}/attendance`);
                const attendanceQuery = query(attendanceRef, where('gradeLevel', '==', grade));
                const attendanceSnapshot = await getDocs(attendanceQuery);
                const attendanceData = attendanceSnapshot.docs
                    .map(d => d.data())
                    .filter(record => record.date >= startDate && record.date <= lastDate);

                // 3. Process data
                const summary = {
                    totalPresent: 0, totalAbsent: 0, totalLate: 0, totalRecords: 0,
                    students: {}
                };

                studentMap.forEach((student, id) => {
                    summary.students[id] = { ...student, id, P: 0, A: 0, L: 0 };
                });

                attendanceData.forEach(record => {
                    for(const studentId in record.studentRecords){
                         if(summary.students[studentId]){
                            const status = record.studentRecords[studentId];
                            summary.students[studentId][status]++;
                            if(status === 'P') summary.totalPresent++;
                            if(status === 'A') summary.totalAbsent++;
                            if(status === 'L') summary.totalLate++;
                            summary.totalRecords++;
                         }
                    }
                });

                renderSummary(summary);

            } catch(error){
                console.error("Error fetching summary: ", error);
                showToast("Failed to load summary.", 'error');
                elements.summaryResultsContainer.innerHTML = '<div class="text-center py-8 text-red-500">Could not load summary data.</div>';
            }
        }
        
        function renderSummary(summaryData) {
            if(summaryData.totalRecords === 0){
                elements.summaryResultsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No attendance records for this month.</div>';
                return;
            }

            const presentPercent = ((summaryData.totalPresent / summaryData.totalRecords) * 100).toFixed(1);
            const absentPercent = ((summaryData.totalAbsent / summaryData.totalRecords) * 100).toFixed(1);
            const latePercent = ((summaryData.totalLate / summaryData.totalRecords) * 100).toFixed(1);

            let html = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-green-100 p-4 rounded-lg">
                        <div class="text-3xl font-bold text-green-700">${presentPercent}%</div>
                        <div class="text-sm text-green-600">Present</div>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg">
                        <div class="text-3xl font-bold text-red-700">${absentPercent}%</div>
                        <div class="text-sm text-red-600">Absent</div>
                    </div>
                    <div class="bg-orange-100 p-4 rounded-lg">
                        <div class="text-3xl font-bold text-orange-700">${latePercent}%</div>
                        <div class="text-sm text-orange-600">Late</div>
                    </div>
                </div>
                <div class="mt-6 border-t pt-4">
                     <h4 class="text-lg font-semibold mb-2">Student Breakdown</h4>
                     <div class="max-h-64 overflow-y-auto pr-2">
                        <div class="grid grid-cols-[1fr,4rem,4rem,4rem] gap-x-4 text-sm font-semibold text-gray-600 px-2 pb-2 border-b">
                           <div>Name</div>
                           <div class="text-center">Present</div>
                           <div class="text-center">Absent</div>
                           <div class="text-center">Late</div>
                        </div>
            `;
            
            const studentArray = Object.values(summaryData.students).sort((a,b) => formatStudentName(a).localeCompare(formatStudentName(b)));

            studentArray.forEach(student => {
                html += `
                    <div class="grid grid-cols-[1fr,4rem,4rem,4rem] gap-x-4 items-center py-2 px-2 border-b hover:bg-gray-50">
                        <div class="truncate">${formatStudentName(student)}</div>
                        <div class="text-center font-medium text-green-600">${student.P}</div>
                        <div class="text-center font-medium text-red-600">${student.A}</div>
                        <div class="text-center font-medium text-orange-600">${student.L}</div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
            elements.summaryResultsContainer.innerHTML = html;
        }

    </script>
</body>
</html>
